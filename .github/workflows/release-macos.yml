name: Release macOS

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write

concurrency:
  group: release-macos-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  build:
    name: Build (${{ matrix.arch }})
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            arch: x64
          - runner: macos-14
            arch: arm64
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install

      - name: Compute version
        id: meta
        run: echo "version=$(echo '${{ github.event.workflow_run.head_sha }}' | cut -c1-12)" >> "$GITHUB_OUTPUT"

      - name: Build macOS package
        run: ./scripts/package-macos.sh "${{ steps.meta.outputs.version }}"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: rem-macos-${{ matrix.arch }}
          path: |
            dist/macos/*.tar.gz
            dist/macos/*.tar.gz.sha256
          if-no-files-found: error

  publish:
    name: Publish GitHub release
    needs: build
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          merge-multiple: true

      - name: Compute release metadata
        id: meta
        run: |
          SHORT_SHA="$(echo '${{ github.event.workflow_run.head_sha }}' | cut -c1-12)"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "name=REM main ${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.event.workflow_run.head_sha }}
          name: ${{ steps.meta.outputs.name }}
          generate_release_notes: true
          overwrite_files: true
          fail_on_unmatched_files: true
          files: |
            dist/release/*.tar.gz
            dist/release/*.tar.gz.sha256
